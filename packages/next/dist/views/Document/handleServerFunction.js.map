{"version":3,"file":"handleServerFunction.js","names":["getClientConfig","headers","getHeaders","getAccessResults","isEntityHidden","parseCookies","renderDocument","renderDocumentHandler","args","collectionSlug","disableActions","docID","drawerSlug","initialData","locale","overrideEntityVisibility","redirectAfterCreate","redirectAfterDelete","redirectAfterDuplicate","req","i18n","payload","config","user","cookies","incomingUserSlug","collection","adminUserSlug","admin","adminAccessFunction","collections","access","canAccessAdmin","Error","hasUsers","find","depth","limit","pagination","docs","length","clientConfig","importMap","preferences","preferencesKey","where","and","key","equals","id","then","res","value","visibleEntities","map","slug","hidden","filter","Boolean","globals","permissions","data","Document","documentSubViewType","initPageResult","collectionConfig","globalConfig","global","languageOptions","undefined","translations","params","segments","searchParams","viewType"],"sources":["../../../src/views/Document/handleServerFunction.tsx"],"sourcesContent":["import type {\n  Data,\n  DocumentPreferences,\n  FormState,\n  Locale,\n  PayloadRequest,\n  VisibleEntities,\n} from 'payload'\n\nimport { getClientConfig } from '@payloadcms/ui/utilities/getClientConfig'\nimport { headers as getHeaders } from 'next/headers.js'\nimport { getAccessResults, isEntityHidden, parseCookies } from 'payload'\n\nimport { renderDocument } from './index.js'\n\ntype RenderDocumentResult = {\n  data: any\n  Document: React.ReactNode\n  preferences: DocumentPreferences\n}\n\nexport const renderDocumentHandler = async (args: {\n  collectionSlug: string\n  disableActions?: boolean\n  docID: string\n  drawerSlug?: string\n  initialData?: Data\n  initialState?: FormState\n  locale?: Locale\n  overrideEntityVisibility?: boolean\n  redirectAfterCreate?: boolean\n  redirectAfterDelete: boolean\n  redirectAfterDuplicate: boolean\n  req: PayloadRequest\n}): Promise<RenderDocumentResult> => {\n  const {\n    collectionSlug,\n    disableActions,\n    docID,\n    drawerSlug,\n    initialData,\n    locale,\n    overrideEntityVisibility,\n    redirectAfterCreate,\n    redirectAfterDelete,\n    redirectAfterDuplicate,\n    req,\n    req: {\n      i18n,\n      payload,\n      payload: { config },\n      user,\n    },\n  } = args\n\n  const headers = await getHeaders()\n\n  const cookies = parseCookies(headers)\n\n  const incomingUserSlug = user?.collection\n\n  const adminUserSlug = config.admin.user\n\n  // If we have a user slug, test it against the functions\n  if (incomingUserSlug) {\n    const adminAccessFunction = payload.collections[incomingUserSlug].config.access?.admin\n\n    // Run the admin access function from the config if it exists\n    if (adminAccessFunction) {\n      const canAccessAdmin = await adminAccessFunction({ req })\n\n      if (!canAccessAdmin) {\n        throw new Error('Unauthorized')\n      }\n      // Match the user collection to the global admin config\n    } else if (adminUserSlug !== incomingUserSlug) {\n      throw new Error('Unauthorized')\n    }\n  } else {\n    const hasUsers = await payload.find({\n      collection: adminUserSlug,\n      depth: 0,\n      limit: 1,\n      pagination: false,\n    })\n\n    // If there are users, we should not allow access because of /create-first-user\n    if (hasUsers.docs.length) {\n      throw new Error('Unauthorized')\n    }\n  }\n\n  const clientConfig = getClientConfig({\n    config,\n    i18n,\n    importMap: req.payload.importMap,\n  })\n\n  let preferences: DocumentPreferences\n\n  if (docID) {\n    const preferencesKey = `${collectionSlug}-edit-${docID}`\n\n    preferences = await payload\n      .find({\n        collection: 'payload-preferences',\n        depth: 0,\n        limit: 1,\n        where: {\n          and: [\n            {\n              key: {\n                equals: preferencesKey,\n              },\n            },\n            {\n              'user.relationTo': {\n                equals: user.collection,\n              },\n            },\n            {\n              'user.value': {\n                equals: user.id,\n              },\n            },\n          ],\n        },\n      })\n      .then((res) => res.docs[0]?.value as DocumentPreferences)\n  }\n\n  const visibleEntities: VisibleEntities = {\n    collections: payload.config.collections\n      .map(({ slug, admin: { hidden } }) => (!isEntityHidden({ hidden, user }) ? slug : null))\n      .filter(Boolean),\n    globals: payload.config.globals\n      .map(({ slug, admin: { hidden } }) => (!isEntityHidden({ hidden, user }) ? slug : null))\n      .filter(Boolean),\n  }\n\n  const permissions = await getAccessResults({\n    req,\n  })\n\n  const { data, Document } = await renderDocument({\n    clientConfig,\n    disableActions,\n    documentSubViewType: 'default',\n    drawerSlug,\n    i18n,\n    importMap: payload.importMap,\n    initialData,\n    initPageResult: {\n      collectionConfig: payload?.collections?.[collectionSlug]?.config,\n      cookies,\n      docID,\n      globalConfig: payload.config.globals.find((global) => global.slug === collectionSlug),\n      languageOptions: undefined, // TODO\n      locale,\n      permissions,\n      req,\n      translations: undefined, // TODO\n      visibleEntities,\n    },\n    overrideEntityVisibility,\n    params: {\n      segments: ['collections', collectionSlug, docID],\n    },\n    payload,\n    redirectAfterCreate,\n    redirectAfterDelete,\n    redirectAfterDuplicate,\n    searchParams: {},\n    viewType: 'document',\n  })\n\n  return {\n    data,\n    Document,\n    preferences,\n  }\n}\n"],"mappings":"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","ignoreList":[]}