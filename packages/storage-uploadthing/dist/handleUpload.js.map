{"version":3,"sources":["../src/handleUpload.ts"],"sourcesContent":["import type { HandleUpload } from '@payloadcms/plugin-cloud-storage/types'\nimport type { UTApi } from 'uploadthing/server'\n\nimport { APIError } from 'payload'\nimport { UTFile } from 'uploadthing/server'\n\nimport type { ACL } from './index.js'\n\ntype HandleUploadArgs = {\n  acl: ACL\n  utApi: UTApi\n}\n\nexport const getHandleUpload = ({ acl, utApi }: HandleUploadArgs): HandleUpload => {\n  return async ({ clientUploadContext, data, file }) => {\n    try {\n      if (\n        clientUploadContext &&\n        typeof clientUploadContext === 'object' &&\n        'key' in clientUploadContext &&\n        typeof clientUploadContext.key === 'string'\n      ) {\n        // Clear the old file\n        await utApi.deleteFiles(clientUploadContext.key)\n      }\n\n      const { buffer, filename, mimeType } = file\n\n      const blob = new Blob([buffer], { type: mimeType })\n      const res = await utApi.uploadFiles(new UTFile([blob], filename), { acl })\n\n      if (res.error) {\n        throw new APIError(`Error uploading file: ${res.error.code} - ${res.error.message}`)\n      }\n\n      // Find matching data.sizes entry\n      const foundSize = Object.keys(data.sizes || {}).find(\n        (key) => data.sizes?.[key]?.filename === filename,\n      )\n\n      if (foundSize) {\n        data.sizes[foundSize]._key = res.data?.key\n      } else {\n        data._key = res.data?.key\n        data.filename = res.data?.name\n      }\n\n      return data\n    } catch (error: unknown) {\n      if (error instanceof Error) {\n        // Interrogate uploadthing error which returns FiberFailure\n        if ('toJSON' in error && typeof error.toJSON === 'function') {\n          const json = error.toJSON() as {\n            cause?: { defect?: { _id?: string; data?: { error?: string }; error?: string } }\n          }\n          if (json.cause?.defect?.error && json.cause.defect.data?.error) {\n            throw new APIError(\n              `Error uploading file with uploadthing: ${json.cause.defect.error} - ${json.cause.defect.data.error}`,\n            )\n          }\n        } else {\n          throw new APIError(`Error uploading file with uploadthing: ${error.message}`)\n        }\n      }\n    }\n  }\n}\n"],"names":["APIError","UTFile","getHandleUpload","acl","utApi","clientUploadContext","data","file","key","deleteFiles","buffer","filename","mimeType","blob","Blob","type","res","uploadFiles","error","code","message","foundSize","Object","keys","sizes","find","_key","name","Error","toJSON","json","cause","defect"],"mappings":"AAGA,SAASA,QAAQ,QAAQ,UAAS;AAClC,SAASC,MAAM,QAAQ,qBAAoB;AAS3C,OAAO,MAAMC,kBAAkB,CAAC,EAAEC,GAAG,EAAEC,KAAK,EAAoB;IAC9D,OAAO,OAAO,EAAEC,mBAAmB,EAAEC,IAAI,EAAEC,IAAI,EAAE;QAC/C,IAAI;YACF,IACEF,uBACA,OAAOA,wBAAwB,YAC/B,SAASA,uBACT,OAAOA,oBAAoBG,GAAG,KAAK,UACnC;gBACA,qBAAqB;gBACrB,MAAMJ,MAAMK,WAAW,CAACJ,oBAAoBG,GAAG;YACjD;YAEA,MAAM,EAAEE,MAAM,EAAEC,QAAQ,EAAEC,QAAQ,EAAE,GAAGL;YAEvC,MAAMM,OAAO,IAAIC,KAAK;gBAACJ;aAAO,EAAE;gBAAEK,MAAMH;YAAS;YACjD,MAAMI,MAAM,MAAMZ,MAAMa,WAAW,CAAC,IAAIhB,OAAO;gBAACY;aAAK,EAAEF,WAAW;gBAAER;YAAI;YAExE,IAAIa,IAAIE,KAAK,EAAE;gBACb,MAAM,IAAIlB,SAAS,CAAC,sBAAsB,EAAEgB,IAAIE,KAAK,CAACC,IAAI,CAAC,GAAG,EAAEH,IAAIE,KAAK,CAACE,OAAO,EAAE;YACrF;YAEA,iCAAiC;YACjC,MAAMC,YAAYC,OAAOC,IAAI,CAACjB,KAAKkB,KAAK,IAAI,CAAC,GAAGC,IAAI,CAClD,CAACjB,MAAQF,KAAKkB,KAAK,EAAE,CAAChB,IAAI,EAAEG,aAAaA;YAG3C,IAAIU,WAAW;gBACbf,KAAKkB,KAAK,CAACH,UAAU,CAACK,IAAI,GAAGV,IAAIV,IAAI,EAAEE;YACzC,OAAO;gBACLF,KAAKoB,IAAI,GAAGV,IAAIV,IAAI,EAAEE;gBACtBF,KAAKK,QAAQ,GAAGK,IAAIV,IAAI,EAAEqB;YAC5B;YAEA,OAAOrB;QACT,EAAE,OAAOY,OAAgB;YACvB,IAAIA,iBAAiBU,OAAO;gBAC1B,2DAA2D;gBAC3D,IAAI,YAAYV,SAAS,OAAOA,MAAMW,MAAM,KAAK,YAAY;oBAC3D,MAAMC,OAAOZ,MAAMW,MAAM;oBAGzB,IAAIC,KAAKC,KAAK,EAAEC,QAAQd,SAASY,KAAKC,KAAK,CAACC,MAAM,CAAC1B,IAAI,EAAEY,OAAO;wBAC9D,MAAM,IAAIlB,SACR,CAAC,uCAAuC,EAAE8B,KAAKC,KAAK,CAACC,MAAM,CAACd,KAAK,CAAC,GAAG,EAAEY,KAAKC,KAAK,CAACC,MAAM,CAAC1B,IAAI,CAACY,KAAK,EAAE;oBAEzG;gBACF,OAAO;oBACL,MAAM,IAAIlB,SAAS,CAAC,uCAAuC,EAAEkB,MAAME,OAAO,EAAE;gBAC9E;YACF;QACF;IACF;AACF,EAAC"}