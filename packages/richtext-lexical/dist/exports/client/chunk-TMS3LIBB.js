import{a as ie}from"./chunk-INBEEENE.js";import{b as se}from"./chunk-BZZVLW4U.js";import{jsx as o,jsxs as p,Fragment as we}from"react/jsx-runtime";import T,{createContext as Ie,useCallback as j,useEffect as N,useMemo as v,useRef as _}from"react";import{useLexicalComposerContext as Ne}from"@lexical/react/LexicalComposerContext";import{getTranslation as ce}from"@payloadcms/translations";import{Button as ae,Drawer as ve,EditDepthProvider as Te,Form as $e,formatDrawerSlug as Oe,FormSubmit as Pe,RenderFields as Re,ShimmerEffect as Ee,useConfig as Le,useDocumentForm as Me,useDocumentInfo as je,useEditDepth as Ae,useServerFunctions as Je,useTranslation as Ke}from"@payloadcms/ui";import{abortAndIgnore as A}from"@payloadcms/ui/shared";import{$getNodeByKey as J}from"lexical";import{deepCopyObjectSimpleWithoutReactComponents as K,reduceFieldsToValues as ze}from"payload/shared";import{v4 as He}from"uuid";import{jsx as Se}from"react/jsx-runtime";import Ce from"bson-objectid";import ye from"react";import Be from"bson-objectid";import{DecoratorNode as _e}from"lexical";var B=class extends _e{__cacheBuster;__fields;constructor({cacheBuster:e,fields:t,key:r}){super(r),this.__fields=t,this.__cacheBuster=e||0}static clone(e){return new this({cacheBuster:e.__cacheBuster,fields:e.__fields,key:e.__key})}static getType(){return"inlineBlock"}static importDOM(){return{}}static importJSON(e){return xe(e.fields)}static isInline(){return!1}canIndent(){return!0}createDOM(){let e=document.createElement("span");return e.classList.add("inline-block-container"),e}decorate(e,t){return null}exportDOM(){let e=document.createElement("span");e.classList.add("inline-block-container");let t=document.createTextNode(this.getTextContent());return e.append(t),{element:e}}exportJSON(){return{type:"inlineBlock",fields:this.getFields(),version:1}}getCacheBuster(){return this.getLatest().__cacheBuster}getFields(){return this.getLatest().__fields}getTextContent(){return"Block Field"}isInline(){return!0}setFields(e,t){let r=this.getWritable();r.__fields=e,t||r.__cacheBuster++}updateDOM(){return!1}};function xe(l){return new B({fields:{...l,id:l?.id||new Be.default().toHexString()}})}var Fe=ye.lazy(()=>import("./componentInline-7ITSVAKP.js").then(l=>({default:l.InlineBlockComponent}))),I=class extends B{static clone(e){return super.clone(e)}static getType(){return super.getType()}static importJSON(e){return De(e.fields)}decorate(e,t){return Se(Fe,{cacheBuster:this.getCacheBuster(),formData:this.getFields(),nodeKey:this.getKey()})}exportJSON(){return super.exportJSON()}};function De(l){return new I({fields:{...l,id:l?.id||new Ce.default().toHexString()}})}function M(l){return l instanceof I}var m="inline-block",ue=Ie({initialState:!1}),ft=()=>T.use(ue),pt=l=>{let{cacheBuster:e,formData:t,nodeKey:r}=l,[a]=Ne(),{i18n:$,t:d}=Ke(),{createdInlineBlock:z,fieldProps:{featureClientSchemaMap:de,initialLexicalFormState:me,permissions:Ve,readOnly:x,schemaPath:H},setCreatedInlineBlock:V,uuid:fe}=se(),{fields:S}=Me(),{getFormState:C}=Je(),pe=Ae(),W=_(!1),[u,q]=T.useState(()=>me?.[t.id]?.formState),G=_(!1),Q=_(e);N(()=>{G.current?(Q.current!==e&&q(!1),Q.current=e):G.current=!0},[e]);let[O,U]=T.useState(u?._components?.customComponents?.BlockLabel),[X,Y]=T.useState(u?._components?.customComponents?.Block),Z=Oe({slug:`lexical-inlineBlocks-create-${fe}-${t.id}`,depth:pe}),{toggleDrawer:b}=ie(Z,!0),be=_(null),{id:y,collectionSlug:F,getDocPreferences:D,globalSlug:w}=je(),{config:ke}=Le(),he=`${H}.lexical_internal_feature.blocks.lexical_inline_blocks.${t.blockType}`,k=de.blocks?.[he]?.[0],i=k.blockReferences?typeof k?.blockReferences?.[0]=="string"?ke.blocksMap[k?.blockReferences?.[0]]:k?.blockReferences?.[0]:k?.blocks?.[0],ee=i?.fields??[];N(()=>{!W.current&&z?.getKey()===r&&(ee.length>2&&b(),V?.(void 0),W.current=!0)},[ee.length,z,r,V,b]);let te=j(()=>{a.update(()=>{J(r)?.remove()})},[a,r]),h=i?.labels?.singular?ce(i?.labels.singular,$):i?.slug,P=_(new AbortController),g=`${H}.lexical_internal_feature.blocks.lexical_inline_blocks.${i?.slug}.fields`;N(()=>{let n=new AbortController;return t&&!u&&(async()=>{let{state:s}=await C({id:y,collectionSlug:F,data:t,docPermissions:{fields:!0},docPreferences:await D(),documentFormState:K(S),globalSlug:w,initialBlockData:t,initialBlockFormState:t,operation:"update",renderAllFields:!0,schemaPath:g,signal:n.signal});if(s){let f=ze(K(s),!0);a.update(()=>{let L=J(r);if(L&&M(L)){let le=f;le.blockType=t.blockType,L.setFields(le,!0)}}),q(s),U(s._components?.customComponents?.BlockLabel),Y(s._components?.customComponents?.Block)}})(),()=>{A(n)}},[C,a,r,g,y,t,u,F,w,D,S]);let ne=j(async({formState:n,submit:c})=>{A(P.current);let s=new AbortController;P.current=s;let{state:f}=await C({id:y,collectionSlug:F,docPermissions:{fields:!0},docPreferences:await D(),documentFormState:K(S),formState:n,globalSlug:w,initialBlockFormState:n,operation:"update",renderAllFields:!!c,schemaPath:g,signal:s.signal});return f?(c&&(U(f._components?.customComponents?.BlockLabel),Y(f._components?.customComponents?.Block)),f):n},[C,y,F,D,S,w,g]);N(()=>()=>{A(P.current)},[]);let ge=j((n,c)=>{c.blockType=t.blockType,a.update(()=>{let s=J(r);s&&M(s)&&s.setFields(c,!0)})},[a,r,t]),R=v(()=>()=>o(ae,{buttonStyle:"icon-label",className:`${m}__removeButton`,disabled:x,icon:"x",onClick:n=>{n.preventDefault(),te()},round:!0,size:"small",tooltip:d("lexical:blocks:inlineBlocks:remove",{label:h})}),[h,x,te,d]),oe=v(()=>()=>o(ae,{buttonStyle:"icon-label",className:`${m}__editButton`,disabled:x,el:"button",icon:"edit",onClick:()=>{b()},round:!0,size:"small",tooltip:d("lexical:blocks:inlineBlocks:edit",{label:h})}),[h,x,d,b]),E=v(()=>({children:n,className:c})=>o("div",{className:[m,m+"-"+t.blockType,c].filter(Boolean).join(" "),ref:be,children:n}),[t.blockType]),re=v(()=>O?()=>O:()=>o("div",{children:i?.labels?ce(i?.labels.singular,$):""}),[O,i?.labels,$]);return i?p($e,{beforeSubmit:[async({formState:n})=>await ne({formState:n,submit:!0})],disableValidationOnSubmit:!0,el:"div",fields:i?.fields,initialState:u||{},onChange:[ne],onSubmit:(n,c)=>{ge(n,c),b()},uuid:He(),children:[o(Te,{children:o(ve,{className:"",slug:Z,title:d(`lexical:blocks:inlineBlocks:${t?.id?"edit":"create"}`,{label:h??d("lexical:blocks:inlineBlocks:label")}),children:u?p(we,{children:[o(Re,{fields:i?.fields,forceRender:!0,parentIndexPath:"",parentPath:"",parentSchemaPath:g,permissions:!0,readOnly:!1}),o(Pe,{programmaticSubmit:!0,children:d("fields:saveChanges")})]}):null})}),X?o(ue,{value:{EditButton:oe,initialState:u,InlineBlockContainer:E,Label:re,nodeKey:r,RemoveButton:R},children:X}):p(E,{children:[u?o(re,{}):o(Ee,{height:"15px",width:"40px"}),a.isEditable()?p("div",{className:`${m}__actions`,children:[o(oe,{}),o(R,{})]}):null]})]}):p(E,{className:`${m}-not-found`,children:[p("span",{children:["Error: Block '",t.blockType,"' not found"]}),a.isEditable()?o("div",{className:`${m}__actions`,children:o(R,{})}):null]})};export{ft as a,pt as b,I as c,De as d,M as e};
//# sourceMappingURL=chunk-TMS3LIBB.js.map
