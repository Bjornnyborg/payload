{"version":3,"sources":["../src/staticHandler.ts"],"sourcesContent":["import type { StaticHandler } from '@payloadcms/plugin-cloud-storage/types'\nimport type { CollectionConfig } from 'payload'\n\nimport { getFilePrefix } from '@payloadcms/plugin-cloud-storage/utilities'\nimport { BlobNotFoundError, head } from '@vercel/blob'\nimport path from 'path'\n\ntype StaticHandlerArgs = {\n  baseUrl: string\n  cacheControlMaxAge?: number\n  token: string\n}\n\nexport const getStaticHandler = (\n  { baseUrl, cacheControlMaxAge = 0, token }: StaticHandlerArgs,\n  collection: CollectionConfig,\n): StaticHandler => {\n  return async (req, { params: { filename } }) => {\n    try {\n      const prefix = await getFilePrefix({ collection, filename, req })\n      const fileKey = path.posix.join(prefix, encodeURIComponent(filename))\n\n      const fileUrl = `${baseUrl}/${fileKey}`\n      const etagFromHeaders = req.headers.get('etag') || req.headers.get('if-none-match')\n      const blobMetadata = await head(fileUrl, { token })\n      const uploadedAtString = blobMetadata.uploadedAt.toISOString()\n      const ETag = `\"${fileKey}-${uploadedAtString}\"`\n\n      const { contentDisposition, contentType, size } = blobMetadata\n\n      if (etagFromHeaders && etagFromHeaders === ETag) {\n        return new Response(null, {\n          headers: new Headers({\n            'Cache-Control': `public, max-age=${cacheControlMaxAge}`,\n            'Content-Disposition': contentDisposition,\n            'Content-Length': String(size),\n            'Content-Type': contentType,\n            ETag,\n          }),\n          status: 304,\n        })\n      }\n\n      const response = await fetch(`${fileUrl}?${uploadedAtString}`, {\n        cache: 'no-store',\n      })\n\n      const blob = await response.blob()\n\n      if (!blob) {\n        return new Response(null, { status: 204, statusText: 'No Content' })\n      }\n\n      const bodyBuffer = await blob.arrayBuffer()\n\n      return new Response(bodyBuffer, {\n        headers: new Headers({\n          'Cache-Control': `public, max-age=${cacheControlMaxAge}`,\n          'Content-Disposition': contentDisposition,\n          'Content-Length': String(size),\n          'Content-Type': contentType,\n          ETag,\n          'Last-Modified': blobMetadata.uploadedAt.toUTCString(),\n        }),\n        status: 200,\n      })\n    } catch (err: unknown) {\n      if (err instanceof BlobNotFoundError) {\n        return new Response(null, { status: 404, statusText: 'Not Found' })\n      }\n      req.payload.logger.error({ err, msg: 'Unexpected error in staticHandler' })\n      return new Response('Internal Server Error', { status: 500 })\n    }\n  }\n}\n"],"names":["getFilePrefix","BlobNotFoundError","head","path","getStaticHandler","baseUrl","cacheControlMaxAge","token","collection","req","params","filename","prefix","fileKey","posix","join","encodeURIComponent","fileUrl","etagFromHeaders","headers","get","blobMetadata","uploadedAtString","uploadedAt","toISOString","ETag","contentDisposition","contentType","size","Response","Headers","String","status","response","fetch","cache","blob","statusText","bodyBuffer","arrayBuffer","toUTCString","err","payload","logger","error","msg"],"mappings":"AAGA,SAASA,aAAa,QAAQ,6CAA4C;AAC1E,SAASC,iBAAiB,EAAEC,IAAI,QAAQ,eAAc;AACtD,OAAOC,UAAU,OAAM;AAQvB,OAAO,MAAMC,mBAAmB,CAC9B,EAAEC,OAAO,EAAEC,qBAAqB,CAAC,EAAEC,KAAK,EAAqB,EAC7DC;IAEA,OAAO,OAAOC,KAAK,EAAEC,QAAQ,EAAEC,QAAQ,EAAE,EAAE;QACzC,IAAI;YACF,MAAMC,SAAS,MAAMZ,cAAc;gBAAEQ;gBAAYG;gBAAUF;YAAI;YAC/D,MAAMI,UAAUV,KAAKW,KAAK,CAACC,IAAI,CAACH,QAAQI,mBAAmBL;YAE3D,MAAMM,UAAU,GAAGZ,QAAQ,CAAC,EAAEQ,SAAS;YACvC,MAAMK,kBAAkBT,IAAIU,OAAO,CAACC,GAAG,CAAC,WAAWX,IAAIU,OAAO,CAACC,GAAG,CAAC;YACnE,MAAMC,eAAe,MAAMnB,KAAKe,SAAS;gBAAEV;YAAM;YACjD,MAAMe,mBAAmBD,aAAaE,UAAU,CAACC,WAAW;YAC5D,MAAMC,OAAO,CAAC,CAAC,EAAEZ,QAAQ,CAAC,EAAES,iBAAiB,CAAC,CAAC;YAE/C,MAAM,EAAEI,kBAAkB,EAAEC,WAAW,EAAEC,IAAI,EAAE,GAAGP;YAElD,IAAIH,mBAAmBA,oBAAoBO,MAAM;gBAC/C,OAAO,IAAII,SAAS,MAAM;oBACxBV,SAAS,IAAIW,QAAQ;wBACnB,iBAAiB,CAAC,gBAAgB,EAAExB,oBAAoB;wBACxD,uBAAuBoB;wBACvB,kBAAkBK,OAAOH;wBACzB,gBAAgBD;wBAChBF;oBACF;oBACAO,QAAQ;gBACV;YACF;YAEA,MAAMC,WAAW,MAAMC,MAAM,GAAGjB,QAAQ,CAAC,EAAEK,kBAAkB,EAAE;gBAC7Da,OAAO;YACT;YAEA,MAAMC,OAAO,MAAMH,SAASG,IAAI;YAEhC,IAAI,CAACA,MAAM;gBACT,OAAO,IAAIP,SAAS,MAAM;oBAAEG,QAAQ;oBAAKK,YAAY;gBAAa;YACpE;YAEA,MAAMC,aAAa,MAAMF,KAAKG,WAAW;YAEzC,OAAO,IAAIV,SAASS,YAAY;gBAC9BnB,SAAS,IAAIW,QAAQ;oBACnB,iBAAiB,CAAC,gBAAgB,EAAExB,oBAAoB;oBACxD,uBAAuBoB;oBACvB,kBAAkBK,OAAOH;oBACzB,gBAAgBD;oBAChBF;oBACA,iBAAiBJ,aAAaE,UAAU,CAACiB,WAAW;gBACtD;gBACAR,QAAQ;YACV;QACF,EAAE,OAAOS,KAAc;YACrB,IAAIA,eAAexC,mBAAmB;gBACpC,OAAO,IAAI4B,SAAS,MAAM;oBAAEG,QAAQ;oBAAKK,YAAY;gBAAY;YACnE;YACA5B,IAAIiC,OAAO,CAACC,MAAM,CAACC,KAAK,CAAC;gBAAEH;gBAAKI,KAAK;YAAoC;YACzE,OAAO,IAAIhB,SAAS,yBAAyB;gBAAEG,QAAQ;YAAI;QAC7D;IACF;AACF,EAAC"}