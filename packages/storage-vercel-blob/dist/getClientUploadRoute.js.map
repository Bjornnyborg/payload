{"version":3,"sources":["../src/getClientUploadRoute.ts"],"sourcesContent":["import type { PayloadHandler, PayloadRequest, UploadCollectionSlug } from 'payload'\n\nimport { handleUpload, type HandleUploadBody } from '@vercel/blob/client'\nimport { APIError, Forbidden } from 'payload'\n\ntype Args = {\n  access?: (args: {\n    collectionSlug: UploadCollectionSlug\n    req: PayloadRequest\n  }) => boolean | Promise<boolean>\n  addRandomSuffix?: boolean\n  cacheControlMaxAge?: number\n  token: string\n}\n\nconst defaultAccess: Args['access'] = ({ req }) => !!req.user\n\nexport const getClientUploadRoute =\n  ({ access = defaultAccess, addRandomSuffix, cacheControlMaxAge, token }: Args): PayloadHandler =>\n  async (req) => {\n    const body = (await req.json!()) as HandleUploadBody\n\n    try {\n      const jsonResponse = await handleUpload({\n        body,\n        onBeforeGenerateToken: async (_pathname: string, collectionSlug: null | string) => {\n          if (!collectionSlug) {\n            throw new APIError('No payload was provided')\n          }\n\n          if (!(await access({ collectionSlug, req }))) {\n            throw new Forbidden()\n          }\n\n          return Promise.resolve({\n            addRandomSuffix,\n            cacheControlMaxAge,\n          })\n        },\n        onUploadCompleted: async () => {},\n        request: req as Request,\n        token,\n      })\n\n      return Response.json(jsonResponse)\n    } catch (error) {\n      req.payload.logger.error(error)\n      throw new APIError('storage-vercel-blob client upload route error')\n    }\n  }\n"],"names":["handleUpload","APIError","Forbidden","defaultAccess","req","user","getClientUploadRoute","access","addRandomSuffix","cacheControlMaxAge","token","body","json","jsonResponse","onBeforeGenerateToken","_pathname","collectionSlug","Promise","resolve","onUploadCompleted","request","Response","error","payload","logger"],"mappings":"AAEA,SAASA,YAAY,QAA+B,sBAAqB;AACzE,SAASC,QAAQ,EAAEC,SAAS,QAAQ,UAAS;AAY7C,MAAMC,gBAAgC,CAAC,EAAEC,GAAG,EAAE,GAAK,CAAC,CAACA,IAAIC,IAAI;AAE7D,OAAO,MAAMC,uBACX,CAAC,EAAEC,SAASJ,aAAa,EAAEK,eAAe,EAAEC,kBAAkB,EAAEC,KAAK,EAAQ,GAC7E,OAAON;QACL,MAAMO,OAAQ,MAAMP,IAAIQ,IAAI;QAE5B,IAAI;YACF,MAAMC,eAAe,MAAMb,aAAa;gBACtCW;gBACAG,uBAAuB,OAAOC,WAAmBC;oBAC/C,IAAI,CAACA,gBAAgB;wBACnB,MAAM,IAAIf,SAAS;oBACrB;oBAEA,IAAI,CAAE,MAAMM,OAAO;wBAAES;wBAAgBZ;oBAAI,IAAK;wBAC5C,MAAM,IAAIF;oBACZ;oBAEA,OAAOe,QAAQC,OAAO,CAAC;wBACrBV;wBACAC;oBACF;gBACF;gBACAU,mBAAmB,WAAa;gBAChCC,SAAShB;gBACTM;YACF;YAEA,OAAOW,SAAST,IAAI,CAACC;QACvB,EAAE,OAAOS,OAAO;YACdlB,IAAImB,OAAO,CAACC,MAAM,CAACF,KAAK,CAACA;YACzB,MAAM,IAAIrB,SAAS;QACrB;IACF,EAAC"}