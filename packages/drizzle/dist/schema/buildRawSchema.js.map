{"version":3,"sources":["../../src/schema/buildRawSchema.ts"],"sourcesContent":["import {\n  buildVersionCollectionFields,\n  buildVersionCompoundIndexes,\n  buildVersionGlobalFields,\n} from 'payload'\nimport toSnakeCase from 'to-snake-case'\n\nimport type { DrizzleAdapter, RawIndex, SetColumnID } from '../types.js'\n\nimport { createTableName } from '../createTableName.js'\nimport { buildTable } from './build.js'\n\n/**\n * Builds abstract Payload SQL schema\n */\nexport const buildRawSchema = ({\n  adapter,\n  setColumnID,\n}: {\n  adapter: DrizzleAdapter\n  setColumnID: SetColumnID\n}) => {\n  adapter.indexes = new Set()\n\n  adapter.payload.config.collections.forEach((collection) => {\n    createTableName({\n      adapter,\n      config: collection,\n    })\n\n    if (collection.versions) {\n      createTableName({\n        adapter,\n        config: collection,\n        versions: true,\n        versionsCustomName: true,\n      })\n    }\n  })\n\n  adapter.payload.config.collections.forEach((collection) => {\n    const tableName = adapter.tableNameMap.get(toSnakeCase(collection.slug))\n    const config = adapter.payload.config\n\n    const baseIndexes: Record<string, RawIndex> = {}\n\n    if (collection.upload.filenameCompoundIndex) {\n      const indexName = `${tableName}_filename_compound_idx`\n\n      baseIndexes.filename_compound_index = {\n        name: indexName,\n        on: collection.upload.filenameCompoundIndex.map((f) => f),\n        unique: true,\n      }\n    }\n\n    buildTable({\n      adapter,\n      compoundIndexes: collection.sanitizedIndexes,\n      disableNotNull: !!collection?.versions?.drafts,\n      disableUnique: false,\n      fields: collection.flattenedFields,\n      parentIsLocalized: false,\n      setColumnID,\n      tableName,\n      timestamps: collection.timestamps,\n      versions: false,\n    })\n\n    if (collection.versions) {\n      const versionsTableName = adapter.tableNameMap.get(\n        `_${toSnakeCase(collection.slug)}${adapter.versionsSuffix}`,\n      )\n      const versionFields = buildVersionCollectionFields(config, collection, true)\n\n      buildTable({\n        adapter,\n        compoundIndexes: buildVersionCompoundIndexes({ indexes: collection.sanitizedIndexes }),\n        disableNotNull: !!collection.versions?.drafts,\n        disableUnique: true,\n        fields: versionFields,\n        parentIsLocalized: false,\n        setColumnID,\n        tableName: versionsTableName,\n        timestamps: true,\n        versions: true,\n      })\n    }\n  })\n\n  adapter.payload.config.globals.forEach((global) => {\n    const tableName = createTableName({\n      adapter,\n      config: global,\n    })\n\n    buildTable({\n      adapter,\n      disableNotNull: !!global?.versions?.drafts,\n      disableUnique: false,\n      fields: global.flattenedFields,\n      parentIsLocalized: false,\n      setColumnID,\n      tableName,\n      timestamps: false,\n      versions: false,\n    })\n\n    if (global.versions) {\n      const versionsTableName = createTableName({\n        adapter,\n        config: global,\n        versions: true,\n        versionsCustomName: true,\n      })\n      const config = adapter.payload.config\n      const versionFields = buildVersionGlobalFields(config, global, true)\n\n      buildTable({\n        adapter,\n        disableNotNull: !!global.versions?.drafts,\n        disableUnique: true,\n        fields: versionFields,\n        parentIsLocalized: false,\n        setColumnID,\n        tableName: versionsTableName,\n        timestamps: true,\n        versions: true,\n      })\n    }\n  })\n}\n"],"names":["buildVersionCollectionFields","buildVersionCompoundIndexes","buildVersionGlobalFields","toSnakeCase","createTableName","buildTable","buildRawSchema","adapter","setColumnID","indexes","Set","payload","config","collections","forEach","collection","versions","versionsCustomName","tableName","tableNameMap","get","slug","baseIndexes","upload","filenameCompoundIndex","indexName","filename_compound_index","name","on","map","f","unique","compoundIndexes","sanitizedIndexes","disableNotNull","drafts","disableUnique","fields","flattenedFields","parentIsLocalized","timestamps","versionsTableName","versionsSuffix","versionFields","globals","global"],"mappings":"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"}