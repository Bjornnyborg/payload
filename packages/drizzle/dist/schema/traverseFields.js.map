{"version":3,"sources":["../../src/schema/traverseFields.ts"],"sourcesContent":["import type { CompoundIndex, FlattenedField } from 'payload'\n\nimport { InvalidConfiguration } from 'payload'\nimport {\n  array,\n  fieldAffectsData,\n  fieldIsVirtual,\n  fieldShouldBeLocalized,\n  optionIsObject,\n} from 'payload/shared'\nimport toSnakeCase from 'to-snake-case'\n\nimport type {\n  DrizzleAdapter,\n  IDType,\n  RawColumn,\n  RawForeignKey,\n  RawIndex,\n  RawRelation,\n  RelationMap,\n  SetColumnID,\n} from '../types.js'\n\nimport { createTableName } from '../createTableName.js'\nimport { buildIndexName } from '../utilities/buildIndexName.js'\nimport { hasLocalesTable } from '../utilities/hasLocalesTable.js'\nimport { validateExistingBlockIsIdentical } from '../utilities/validateExistingBlockIsIdentical.js'\nimport { buildTable } from './build.js'\nimport { idToUUID } from './idToUUID.js'\nimport { withDefault } from './withDefault.js'\n\ntype Args = {\n  adapter: DrizzleAdapter\n  columnPrefix?: string\n  columns: Record<string, RawColumn>\n  disableNotNull: boolean\n  disableRelsTableUnique?: boolean\n  disableUnique?: boolean\n  fieldPrefix?: string\n  fields: FlattenedField[]\n  forceLocalized?: boolean\n  indexes: Record<string, RawIndex>\n  localesColumns: Record<string, RawColumn>\n  localesIndexes: Record<string, RawIndex>\n  newTableName: string\n  parentIsLocalized: boolean\n  parentTableName: string\n  relationships: Set<string>\n  relationsToBuild: RelationMap\n  rootRelationsToBuild?: RelationMap\n  rootTableIDColType: IDType\n  rootTableName: string\n  setColumnID: SetColumnID\n  uniqueRelationships: Set<string>\n  versions: boolean\n  /**\n   * Tracks whether or not this table is built\n   * from the result of a localized array or block field at some point\n   */\n  withinLocalizedArrayOrBlock?: boolean\n}\n\ntype Result = {\n  hasLocalizedField: boolean\n  hasLocalizedManyNumberField: boolean\n  hasLocalizedManyTextField: boolean\n  hasLocalizedRelationshipField: boolean\n  hasManyNumberField: 'index' | boolean\n  hasManyTextField: 'index' | boolean\n}\n\nexport const traverseFields = ({\n  adapter,\n  columnPrefix,\n  columns,\n  disableNotNull,\n  disableRelsTableUnique,\n  disableUnique = false,\n  fieldPrefix,\n  fields,\n  forceLocalized,\n  indexes,\n  localesColumns,\n  localesIndexes,\n  newTableName,\n  parentIsLocalized,\n  parentTableName,\n  relationships,\n  relationsToBuild,\n  rootRelationsToBuild,\n  rootTableIDColType,\n  rootTableName,\n  setColumnID,\n  uniqueRelationships,\n  versions,\n  withinLocalizedArrayOrBlock,\n}: Args): Result => {\n  const throwValidationError = true\n  let hasLocalizedField = false\n  let hasLocalizedRelationshipField = false\n  let hasManyTextField: 'index' | boolean = false\n  let hasLocalizedManyTextField = false\n  let hasManyNumberField: 'index' | boolean = false\n  let hasLocalizedManyNumberField = false\n\n  let parentIDColType: IDType = 'integer'\n\n  const idColumn = columns.id\n\n  if (idColumn && ['numeric', 'text', 'uuid', 'varchar'].includes(idColumn.type)) {\n    parentIDColType = idColumn.type as IDType\n  }\n\n  fields.forEach((field) => {\n    if ('name' in field && field.name === 'id') {\n      return\n    }\n    if (fieldIsVirtual(field)) {\n      return\n    }\n\n    let targetTable = columns\n    let targetIndexes = indexes\n\n    const columnName = `${columnPrefix || ''}${field.name[0] === '_' ? '_' : ''}${toSnakeCase(\n      field.name,\n    )}`\n    const fieldName = `${fieldPrefix?.replace('.', '_') || ''}${field.name}`\n\n    const isFieldLocalized = fieldShouldBeLocalized({ field, parentIsLocalized })\n\n    // If field is localized,\n    // add the column to the locale table instead of main table\n    if (\n      adapter.payload.config.localization &&\n      (isFieldLocalized || forceLocalized) &&\n      field.type !== 'array' &&\n      field.type !== 'blocks' &&\n      (('hasMany' in field && field.hasMany !== true) || !('hasMany' in field))\n    ) {\n      hasLocalizedField = true\n      targetTable = localesColumns\n      targetIndexes = localesIndexes\n    }\n\n    if (\n      (field.unique || field.index || ['relationship', 'upload'].includes(field.type)) &&\n      !['array', 'blocks', 'group'].includes(field.type) &&\n      !('hasMany' in field && field.hasMany === true) &&\n      !('relationTo' in field && Array.isArray(field.relationTo))\n    ) {\n      const unique = disableUnique !== true && field.unique\n      if (unique) {\n        const constraintValue = `${fieldPrefix || ''}${field.name}`\n        if (!adapter.fieldConstraints?.[rootTableName]) {\n          adapter.fieldConstraints[rootTableName] = {}\n        }\n        adapter.fieldConstraints[rootTableName][`${columnName}_idx`] = constraintValue\n      }\n\n      const indexName = buildIndexName({ name: `${newTableName}_${columnName}`, adapter })\n\n      targetIndexes[indexName] = {\n        name: indexName,\n        on: isFieldLocalized ? [fieldName, '_locale'] : fieldName,\n        unique,\n      }\n    }\n\n    switch (field.type) {\n      case 'array': {\n        const disableNotNullFromHere = Boolean(field.admin?.condition) || disableNotNull\n\n        const arrayTableName = createTableName({\n          adapter,\n          config: field,\n          parentTableName: newTableName,\n          prefix: `${newTableName}_`,\n          throwValidationError,\n          versionsCustomName: versions,\n        })\n\n        const baseColumns: Record<string, RawColumn> = {\n          _order: {\n            name: '_order',\n            type: 'integer',\n            notNull: true,\n          },\n          _parentID: {\n            name: '_parent_id',\n            type: parentIDColType,\n            notNull: true,\n          },\n        }\n\n        const baseIndexes: Record<string, RawIndex> = {\n          _orderIdx: {\n            name: `${arrayTableName}_order_idx`,\n            on: ['_order'],\n          },\n          _parentIDIdx: {\n            name: `${arrayTableName}_parent_id_idx`,\n            on: '_parentID',\n          },\n        }\n\n        const baseForeignKeys: Record<string, RawForeignKey> = {\n          _parentIDFk: {\n            name: `${arrayTableName}_parent_id_fk`,\n            columns: ['_parentID'],\n            foreignColumns: [\n              {\n                name: 'id',\n                table: parentTableName,\n              },\n            ],\n            onDelete: 'cascade',\n          },\n        }\n\n        const isLocalized =\n          Boolean(isFieldLocalized && adapter.payload.config.localization) ||\n          withinLocalizedArrayOrBlock ||\n          forceLocalized\n\n        if (isLocalized) {\n          baseColumns._locale = {\n            name: '_locale',\n            type: 'enum',\n            locale: true,\n            notNull: true,\n          }\n\n          baseIndexes._localeIdx = {\n            name: `${arrayTableName}_locale_idx`,\n            on: '_locale',\n          }\n        }\n\n        const {\n          hasLocalizedManyNumberField: subHasLocalizedManyNumberField,\n          hasLocalizedManyTextField: subHasLocalizedManyTextField,\n          hasLocalizedRelationshipField: subHasLocalizedRelationshipField,\n          hasManyNumberField: subHasManyNumberField,\n          hasManyTextField: subHasManyTextField,\n          relationsToBuild: subRelationsToBuild,\n        } = buildTable({\n          adapter,\n          baseColumns,\n          baseForeignKeys,\n          baseIndexes,\n          disableNotNull: disableNotNullFromHere,\n          disableRelsTableUnique: true,\n          disableUnique,\n          fields: disableUnique ? idToUUID(field.flattenedFields) : field.flattenedFields,\n          parentIsLocalized: parentIsLocalized || field.localized,\n          rootRelationships: relationships,\n          rootRelationsToBuild,\n          rootTableIDColType,\n          rootTableName,\n          rootUniqueRelationships: uniqueRelationships,\n          setColumnID,\n          tableName: arrayTableName,\n          versions,\n          withinLocalizedArrayOrBlock: isLocalized,\n        })\n\n        if (subHasLocalizedManyNumberField) {\n          hasLocalizedManyNumberField = subHasLocalizedManyNumberField\n        }\n\n        if (subHasLocalizedRelationshipField) {\n          hasLocalizedRelationshipField = subHasLocalizedRelationshipField\n        }\n\n        if (subHasLocalizedManyTextField) {\n          hasLocalizedManyTextField = subHasLocalizedManyTextField\n        }\n\n        if (subHasManyTextField) {\n          if (!hasManyTextField || subHasManyTextField === 'index') {\n            hasManyTextField = subHasManyTextField\n          }\n        }\n        if (subHasManyNumberField) {\n          if (!hasManyNumberField || subHasManyNumberField === 'index') {\n            hasManyNumberField = subHasManyNumberField\n          }\n        }\n\n        const relationName = field.dbName ? `_${arrayTableName}` : fieldName\n\n        relationsToBuild.set(relationName, {\n          type: 'many',\n          // arrays have their own localized table, independent of the base table.\n          localized: false,\n          target: arrayTableName,\n        })\n\n        const arrayRelations: Record<string, RawRelation> = {\n          _parentID: {\n            type: 'one',\n            fields: [\n              {\n                name: '_parentID',\n                table: arrayTableName,\n              },\n            ],\n            references: ['id'],\n            relationName,\n            to: parentTableName,\n          },\n        }\n\n        if (\n          hasLocalesTable({\n            fields: field.fields,\n            parentIsLocalized: parentIsLocalized || field.localized,\n          })\n        ) {\n          arrayRelations._locales = {\n            type: 'many',\n            relationName: '_locales',\n            to: `${arrayTableName}${adapter.localesSuffix}`,\n          }\n        }\n\n        subRelationsToBuild.forEach(({ type, localized, target }, key) => {\n          if (type === 'one') {\n            const arrayWithLocalized = localized\n              ? `${arrayTableName}${adapter.localesSuffix}`\n              : arrayTableName\n\n            arrayRelations[key] = {\n              type: 'one',\n              fields: [\n                {\n                  name: key,\n                  table: arrayWithLocalized,\n                },\n              ],\n              references: ['id'],\n              relationName: key,\n              to: target,\n            }\n          }\n\n          if (type === 'many') {\n            arrayRelations[key] = {\n              type: 'many',\n              relationName: key,\n              to: target,\n            }\n          }\n        })\n\n        adapter.rawRelations[arrayTableName] = arrayRelations\n\n        break\n      }\n      case 'blocks': {\n        const disableNotNullFromHere = Boolean(field.admin?.condition) || disableNotNull\n\n        ;(field.blockReferences ?? field.blocks).forEach((_block) => {\n          const block = typeof _block === 'string' ? adapter.payload.blocks[_block] : _block\n\n          const blockTableName = createTableName({\n            adapter,\n            config: block,\n            parentTableName: rootTableName,\n            prefix: `${rootTableName}_blocks_`,\n            throwValidationError,\n            versionsCustomName: versions,\n          })\n          if (!adapter.rawTables[blockTableName]) {\n            const baseColumns: Record<string, RawColumn> = {\n              _order: {\n                name: '_order',\n                type: 'integer',\n                notNull: true,\n              },\n              _parentID: {\n                name: '_parent_id',\n                type: rootTableIDColType,\n                notNull: true,\n              },\n              _path: {\n                name: '_path',\n                type: 'text',\n                notNull: true,\n              },\n            }\n\n            const baseIndexes: Record<string, RawIndex> = {\n              _orderIdx: {\n                name: `${blockTableName}_order_idx`,\n                on: '_order',\n              },\n              _parentIDIdx: {\n                name: `${blockTableName}_parent_id_idx`,\n                on: ['_parentID'],\n              },\n              _pathIdx: {\n                name: `${blockTableName}_path_idx`,\n                on: '_path',\n              },\n            }\n\n            const baseForeignKeys: Record<string, RawForeignKey> = {\n              _parentIdFk: {\n                name: `${blockTableName}_parent_id_fk`,\n                columns: ['_parentID'],\n                foreignColumns: [\n                  {\n                    name: 'id',\n                    table: rootTableName,\n                  },\n                ],\n                onDelete: 'cascade',\n              },\n            }\n\n            const isLocalized =\n              Boolean(isFieldLocalized && adapter.payload.config.localization) ||\n              withinLocalizedArrayOrBlock ||\n              forceLocalized\n\n            if (isLocalized) {\n              baseColumns._locale = {\n                name: '_locale',\n                type: 'enum',\n                locale: true,\n                notNull: true,\n              }\n\n              baseIndexes._localeIdx = {\n                name: `${blockTableName}_locale_idx`,\n                on: '_locale',\n              }\n            }\n\n            const {\n              hasLocalizedManyNumberField: subHasLocalizedManyNumberField,\n              hasLocalizedManyTextField: subHasLocalizedManyTextField,\n              hasLocalizedRelationshipField: subHasLocalizedRelationshipField,\n              hasManyNumberField: subHasManyNumberField,\n              hasManyTextField: subHasManyTextField,\n              relationsToBuild: subRelationsToBuild,\n            } = buildTable({\n              adapter,\n              baseColumns,\n              baseForeignKeys,\n              baseIndexes,\n              disableNotNull: disableNotNullFromHere,\n              disableRelsTableUnique: true,\n              disableUnique,\n              fields: disableUnique ? idToUUID(block.flattenedFields) : block.flattenedFields,\n              parentIsLocalized: parentIsLocalized || field.localized,\n              rootRelationships: relationships,\n              rootRelationsToBuild,\n              rootTableIDColType,\n              rootTableName,\n              rootUniqueRelationships: uniqueRelationships,\n              setColumnID,\n              tableName: blockTableName,\n              versions,\n              withinLocalizedArrayOrBlock: isLocalized,\n            })\n\n            if (subHasLocalizedManyNumberField) {\n              hasLocalizedManyNumberField = subHasLocalizedManyNumberField\n            }\n\n            if (subHasLocalizedRelationshipField) {\n              hasLocalizedRelationshipField = subHasLocalizedRelationshipField\n            }\n\n            if (subHasLocalizedManyTextField) {\n              hasLocalizedManyTextField = subHasLocalizedManyTextField\n            }\n\n            if (subHasManyTextField) {\n              if (!hasManyTextField || subHasManyTextField === 'index') {\n                hasManyTextField = subHasManyTextField\n              }\n            }\n\n            if (subHasManyNumberField) {\n              if (!hasManyNumberField || subHasManyNumberField === 'index') {\n                hasManyNumberField = subHasManyNumberField\n              }\n            }\n\n            const blockRelations: Record<string, RawRelation> = {\n              _parentID: {\n                type: 'one',\n                fields: [\n                  {\n                    name: '_parentID',\n                    table: blockTableName,\n                  },\n                ],\n                references: ['id'],\n                relationName: `_blocks_${block.slug}`,\n                to: rootTableName,\n              },\n            }\n\n            if (\n              hasLocalesTable({\n                fields: block.fields,\n                parentIsLocalized: parentIsLocalized || field.localized,\n              })\n            ) {\n              blockRelations._locales = {\n                type: 'many',\n                relationName: '_locales',\n                to: `${blockTableName}${adapter.localesSuffix}`,\n              }\n            }\n\n            subRelationsToBuild.forEach(({ type, localized, target }, key) => {\n              if (type === 'one') {\n                const blockWithLocalized = localized\n                  ? `${blockTableName}${adapter.localesSuffix}`\n                  : blockTableName\n\n                blockRelations[key] = {\n                  type: 'one',\n                  fields: [\n                    {\n                      name: key,\n                      table: blockWithLocalized,\n                    },\n                  ],\n                  references: ['id'],\n                  relationName: key,\n                  to: target,\n                }\n              }\n\n              if (type === 'many') {\n                blockRelations[key] = {\n                  type: 'many',\n                  relationName: key,\n                  to: target,\n                }\n              }\n            })\n\n            adapter.rawRelations[blockTableName] = blockRelations\n          } else if (process.env.NODE_ENV !== 'production' && !versions) {\n            validateExistingBlockIsIdentical({\n              block,\n              localized: field.localized,\n              parentIsLocalized: parentIsLocalized || field.localized,\n              rootTableName,\n              table: adapter.rawTables[blockTableName],\n              tableLocales: adapter.rawTables[`${blockTableName}${adapter.localesSuffix}`],\n            })\n          }\n          // blocks relationships are defined from the collection or globals table down to the block, bypassing any subBlocks\n          rootRelationsToBuild.set(`_blocks_${block.slug}`, {\n            type: 'many',\n            // blocks are not localized on the parent table\n            localized: false,\n            target: blockTableName,\n          })\n        })\n\n        break\n      }\n      case 'checkbox': {\n        targetTable[fieldName] = withDefault(\n          {\n            name: columnName,\n            type: 'boolean',\n          },\n          field,\n        )\n\n        break\n      }\n\n      case 'code':\n      case 'email':\n      case 'textarea': {\n        targetTable[fieldName] = withDefault(\n          {\n            name: columnName,\n            type: 'varchar',\n          },\n          field,\n        )\n\n        break\n      }\n\n      case 'date': {\n        targetTable[fieldName] = withDefault(\n          {\n            name: columnName,\n            type: 'timestamp',\n            mode: 'string',\n            precision: 3,\n            withTimezone: true,\n          },\n          field,\n        )\n\n        break\n      }\n\n      case 'group':\n      case 'tab': {\n        const disableNotNullFromHere = Boolean(field.admin?.condition) || disableNotNull\n\n        const {\n          hasLocalizedField: groupHasLocalizedField,\n          hasLocalizedManyNumberField: groupHasLocalizedManyNumberField,\n          hasLocalizedManyTextField: groupHasLocalizedManyTextField,\n          hasLocalizedRelationshipField: groupHasLocalizedRelationshipField,\n          hasManyNumberField: groupHasManyNumberField,\n          hasManyTextField: groupHasManyTextField,\n        } = traverseFields({\n          adapter,\n          columnPrefix: `${columnName}_`,\n          columns,\n          disableNotNull: disableNotNullFromHere,\n          disableUnique,\n          fieldPrefix: `${fieldName}.`,\n          fields: field.flattenedFields,\n          forceLocalized: isFieldLocalized,\n          indexes,\n          localesColumns,\n          localesIndexes,\n          newTableName: `${parentTableName}_${columnName}`,\n          parentIsLocalized: parentIsLocalized || field.localized,\n          parentTableName,\n          relationships,\n          relationsToBuild,\n          rootRelationsToBuild,\n          rootTableIDColType,\n          rootTableName,\n          setColumnID,\n          uniqueRelationships,\n          versions,\n          withinLocalizedArrayOrBlock: withinLocalizedArrayOrBlock || isFieldLocalized,\n        })\n\n        if (groupHasLocalizedField) {\n          hasLocalizedField = true\n        }\n        if (groupHasLocalizedRelationshipField) {\n          hasLocalizedRelationshipField = true\n        }\n        if (groupHasManyTextField) {\n          hasManyTextField = true\n        }\n        if (groupHasLocalizedManyTextField) {\n          hasLocalizedManyTextField = true\n        }\n        if (groupHasManyNumberField) {\n          hasManyNumberField = true\n        }\n        if (groupHasLocalizedManyNumberField) {\n          hasLocalizedManyNumberField = true\n        }\n        break\n      }\n\n      case 'json':\n      case 'richText': {\n        targetTable[fieldName] = withDefault(\n          {\n            name: columnName,\n            type: 'jsonb',\n          },\n          field,\n        )\n\n        break\n      }\n\n      case 'number': {\n        if (field.hasMany) {\n          const isLocalized =\n            Boolean(isFieldLocalized && adapter.payload.config.localization) ||\n            withinLocalizedArrayOrBlock ||\n            forceLocalized\n\n          if (isLocalized) {\n            hasLocalizedManyNumberField = true\n          }\n\n          if (field.index) {\n            hasManyNumberField = 'index'\n          } else if (!hasManyNumberField) {\n            hasManyNumberField = true\n          }\n\n          if (field.unique) {\n            throw new InvalidConfiguration(\n              'Unique is not supported in Postgres for hasMany number fields.',\n            )\n          }\n        } else {\n          targetTable[fieldName] = withDefault(\n            {\n              name: columnName,\n              type: 'numeric',\n            },\n            field,\n          )\n        }\n\n        break\n      }\n\n      case 'point': {\n        targetTable[fieldName] = withDefault(\n          {\n            name: columnName,\n            type: 'geometry',\n          },\n          field,\n        )\n\n        break\n      }\n\n      case 'radio':\n      case 'select': {\n        const enumName = createTableName({\n          adapter,\n          config: field,\n          parentTableName: newTableName,\n          prefix: `enum_${newTableName}_`,\n          target: 'enumName',\n          throwValidationError,\n        })\n\n        const options = field.options.map((option) => {\n          if (optionIsObject(option)) {\n            return option.value\n          }\n\n          return option\n        })\n\n        if (field.type === 'select' && field.hasMany) {\n          const selectTableName = createTableName({\n            adapter,\n            config: field,\n            parentTableName: newTableName,\n            prefix: `${newTableName}_`,\n            throwValidationError,\n            versionsCustomName: versions,\n          })\n\n          const baseColumns: Record<string, RawColumn> = {\n            order: {\n              name: 'order',\n              type: 'integer',\n              notNull: true,\n            },\n            parent: {\n              name: 'parent_id',\n              type: parentIDColType,\n              notNull: true,\n            },\n            value: {\n              name: 'value',\n              type: 'enum',\n              enumName: createTableName({\n                adapter,\n                config: field,\n                parentTableName: newTableName,\n                prefix: `enum_${newTableName}_`,\n                target: 'enumName',\n                throwValidationError,\n              }),\n              options,\n            },\n          }\n\n          const baseIndexes: Record<string, RawIndex> = {\n            orderIdx: {\n              name: `${selectTableName}_order_idx`,\n              on: 'order',\n            },\n            parentIdx: {\n              name: `${selectTableName}_parent_idx`,\n              on: 'parent',\n            },\n          }\n\n          const baseForeignKeys: Record<string, RawForeignKey> = {\n            parentFk: {\n              name: `${selectTableName}_parent_fk`,\n              columns: ['parent'],\n              foreignColumns: [\n                {\n                  name: 'id',\n                  table: parentTableName,\n                },\n              ],\n              onDelete: 'cascade',\n            },\n          }\n\n          const isLocalized =\n            Boolean(isFieldLocalized && adapter.payload.config.localization) ||\n            withinLocalizedArrayOrBlock ||\n            forceLocalized\n\n          if (isLocalized) {\n            baseColumns.locale = {\n              name: 'locale',\n              type: 'enum',\n              locale: true,\n              notNull: true,\n            }\n\n            baseIndexes.localeIdx = {\n              name: `${selectTableName}_locale_idx`,\n              on: 'locale',\n            }\n          }\n\n          if (field.index) {\n            baseIndexes.value = {\n              name: `${selectTableName}_value_idx`,\n              on: 'value',\n            }\n          }\n\n          buildTable({\n            adapter,\n            baseColumns,\n            baseForeignKeys,\n            baseIndexes,\n            disableNotNull,\n            disableUnique,\n            fields: [],\n            parentIsLocalized: parentIsLocalized || field.localized,\n            rootTableName,\n            setColumnID,\n            tableName: selectTableName,\n            versions,\n          })\n\n          relationsToBuild.set(fieldName, {\n            type: 'many',\n            // selects have their own localized table, independent of the base table.\n            localized: false,\n            target: selectTableName,\n          })\n\n          adapter.rawRelations[selectTableName] = {\n            parent: {\n              type: 'one',\n              fields: [\n                {\n                  name: 'parent',\n                  table: selectTableName,\n                },\n              ],\n              references: ['id'],\n              relationName: fieldName,\n              to: parentTableName,\n            },\n          }\n        } else {\n          targetTable[fieldName] = withDefault(\n            {\n              name: columnName,\n              type: 'enum',\n              enumName,\n              options,\n            },\n            field,\n          )\n        }\n        break\n      }\n\n      case 'relationship':\n      case 'upload':\n        if (Array.isArray(field.relationTo)) {\n          field.relationTo.forEach((relation) => {\n            relationships.add(relation)\n            if (field.unique && !disableUnique && !disableRelsTableUnique) {\n              uniqueRelationships.add(relation)\n            }\n          })\n        } else if (field.hasMany) {\n          relationships.add(field.relationTo)\n          if (field.unique && !disableUnique && !disableRelsTableUnique) {\n            uniqueRelationships.add(field.relationTo)\n          }\n        } else {\n          // simple relationships get a column on the targetTable with a foreign key to the relationTo table\n          const relationshipConfig = adapter.payload.collections[field.relationTo].config\n\n          const tableName = adapter.tableNameMap.get(toSnakeCase(field.relationTo))\n\n          // get the id type of the related collection\n          let colType: IDType = adapter.idType === 'uuid' ? 'uuid' : 'integer'\n          const relatedCollectionCustomID = relationshipConfig.fields.find(\n            (field) => fieldAffectsData(field) && field.name === 'id',\n          )\n          if (relatedCollectionCustomID?.type === 'number') {\n            colType = 'numeric'\n          }\n          if (relatedCollectionCustomID?.type === 'text') {\n            colType = 'varchar'\n          }\n\n          // make the foreign key column for relationship using the correct id column type\n          targetTable[fieldName] = {\n            name: `${columnName}_id`,\n            type: colType,\n            reference: {\n              name: 'id',\n              onDelete: 'set null',\n              table: tableName,\n            },\n          }\n\n          // add relationship to table\n          relationsToBuild.set(fieldName, {\n            type: 'one',\n            localized: adapter.payload.config.localization && (isFieldLocalized || forceLocalized),\n            target: tableName,\n          })\n\n          // add notNull when not required\n          if (!disableNotNull && field.required && !field.admin?.condition) {\n            targetTable[fieldName].notNull = true\n          }\n          break\n        }\n\n        if (\n          Boolean(isFieldLocalized && adapter.payload.config.localization) ||\n          withinLocalizedArrayOrBlock\n        ) {\n          hasLocalizedRelationshipField = true\n        }\n\n        break\n\n      case 'text': {\n        if (field.hasMany) {\n          const isLocalized =\n            Boolean(isFieldLocalized && adapter.payload.config.localization) ||\n            withinLocalizedArrayOrBlock ||\n            forceLocalized\n\n          if (isLocalized) {\n            hasLocalizedManyTextField = true\n          }\n\n          if (field.index) {\n            hasManyTextField = 'index'\n          } else if (!hasManyTextField) {\n            hasManyTextField = true\n          }\n\n          if (field.unique) {\n            throw new InvalidConfiguration(\n              'Unique is not supported in Postgres for hasMany text fields.',\n            )\n          }\n        } else {\n          targetTable[fieldName] = withDefault(\n            {\n              name: columnName,\n              type: 'varchar',\n            },\n            field,\n          )\n        }\n        break\n      }\n\n      default:\n        break\n    }\n\n    const condition = field.admin && field.admin.condition\n\n    if (\n      !disableNotNull &&\n      targetTable[fieldName] &&\n      'required' in field &&\n      field.required &&\n      !condition\n    ) {\n      targetTable[fieldName].notNull = true\n    }\n  })\n\n  return {\n    hasLocalizedField,\n    hasLocalizedManyNumberField,\n    hasLocalizedManyTextField,\n    hasLocalizedRelationshipField,\n    hasManyNumberField,\n    hasManyTextField,\n  }\n}\n"],"names":["InvalidConfiguration","fieldAffectsData","fieldIsVirtual","fieldShouldBeLocalized","optionIsObject","toSnakeCase","createTableName","buildIndexName","hasLocalesTable","validateExistingBlockIsIdentical","buildTable","idToUUID","withDefault","traverseFields","adapter","columnPrefix","columns","disableNotNull","disableRelsTableUnique","disableUnique","fieldPrefix","fields","forceLocalized","indexes","localesColumns","localesIndexes","newTableName","parentIsLocalized","parentTableName","relationships","relationsToBuild","rootRelationsToBuild","rootTableIDColType","rootTableName","setColumnID","uniqueRelationships","versions","withinLocalizedArrayOrBlock","throwValidationError","hasLocalizedField","hasLocalizedRelationshipField","hasManyTextField","hasLocalizedManyTextField","hasManyNumberField","hasLocalizedManyNumberField","parentIDColType","idColumn","id","includes","type","forEach","field","name","targetTable","targetIndexes","columnName","fieldName","replace","isFieldLocalized","payload","config","localization","hasMany","unique","index","Array","isArray","relationTo","constraintValue","fieldConstraints","indexName","on","disableNotNullFromHere","Boolean","admin","condition","arrayTableName","prefix","versionsCustomName","baseColumns","_order","notNull","_parentID","baseIndexes","_orderIdx","_parentIDIdx","baseForeignKeys","_parentIDFk","foreignColumns","table","onDelete","isLocalized","_locale","locale","_localeIdx","subHasLocalizedManyNumberField","subHasLocalizedManyTextField","subHasLocalizedRelationshipField","subHasManyNumberField","subHasManyTextField","subRelationsToBuild","flattenedFields","localized","rootRelationships","rootUniqueRelationships","tableName","relationName","dbName","set","target","arrayRelations","references","to","_locales","localesSuffix","key","arrayWithLocalized","rawRelations","blockReferences","blocks","_block","block","blockTableName","rawTables","_path","_pathIdx","_parentIdFk","blockRelations","slug","blockWithLocalized","process","env","NODE_ENV","tableLocales","mode","precision","withTimezone","groupHasLocalizedField","groupHasLocalizedManyNumberField","groupHasLocalizedManyTextField","groupHasLocalizedRelationshipField","groupHasManyNumberField","groupHasManyTextField","enumName","options","map","option","value","selectTableName","order","parent","orderIdx","parentIdx","parentFk","localeIdx","relation","add","relationshipConfig","collections","tableNameMap","get","colType","idType","relatedCollectionCustomID","find","reference","required"],"mappings":"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"}