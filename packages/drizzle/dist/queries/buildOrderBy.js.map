{"version":3,"sources":["../../src/queries/buildOrderBy.ts"],"sourcesContent":["import type { Table } from 'drizzle-orm'\nimport type { FlattenedField, Sort } from 'payload'\n\nimport { asc, desc } from 'drizzle-orm'\n\nimport type { DrizzleAdapter, GenericColumn } from '../types.js'\nimport type { BuildQueryJoinAliases, BuildQueryResult } from './buildQuery.js'\n\nimport { getNameFromDrizzleTable } from '../utilities/getNameFromDrizzleTable.js'\nimport { getTableColumnFromPath } from './getTableColumnFromPath.js'\n\ntype Args = {\n  adapter: DrizzleAdapter\n  aliasTable?: Table\n  fields: FlattenedField[]\n  joins: BuildQueryJoinAliases\n  locale?: string\n  parentIsLocalized: boolean\n  selectFields: Record<string, GenericColumn>\n  sort?: Sort\n  tableName: string\n}\n\n/**\n * Gets the order by column and direction constructed from the sort argument adds the column to the select fields and joins if necessary\n */\nexport const buildOrderBy = ({\n  adapter,\n  aliasTable,\n  fields,\n  joins,\n  locale,\n  parentIsLocalized,\n  selectFields,\n  sort,\n  tableName,\n}: Args): BuildQueryResult['orderBy'] => {\n  const orderBy: BuildQueryResult['orderBy'] = []\n\n  if (!sort) {\n    const createdAt = adapter.tables[tableName]?.createdAt\n    if (createdAt) {\n      sort = '-createdAt'\n    } else {\n      sort = '-id'\n    }\n  }\n\n  if (typeof sort === 'string') {\n    sort = [sort]\n  }\n\n  for (const sortItem of sort) {\n    let sortProperty: string\n    let sortDirection: 'asc' | 'desc'\n    if (sortItem[0] === '-') {\n      sortProperty = sortItem.substring(1)\n      sortDirection = 'desc'\n    } else {\n      sortProperty = sortItem\n      sortDirection = 'asc'\n    }\n    try {\n      const { columnName: sortTableColumnName, table: sortTable } = getTableColumnFromPath({\n        adapter,\n        collectionPath: sortProperty,\n        fields,\n        joins,\n        locale,\n        parentIsLocalized,\n        pathSegments: sortProperty.replace(/__/g, '.').split('.'),\n        selectFields,\n        tableName,\n        value: sortProperty,\n      })\n      if (sortTable?.[sortTableColumnName]) {\n        orderBy.push({\n          column:\n            aliasTable && tableName === getNameFromDrizzleTable(sortTable)\n              ? aliasTable[sortTableColumnName]\n              : sortTable[sortTableColumnName],\n          order: sortDirection === 'asc' ? asc : desc,\n        })\n\n        selectFields[sortTableColumnName] = sortTable[sortTableColumnName]\n      }\n    } catch (err) {\n      // continue\n    }\n  }\n\n  return orderBy\n}\n"],"names":["asc","desc","getNameFromDrizzleTable","getTableColumnFromPath","buildOrderBy","adapter","aliasTable","fields","joins","locale","parentIsLocalized","selectFields","sort","tableName","orderBy","createdAt","tables","sortItem","sortProperty","sortDirection","substring","columnName","sortTableColumnName","table","sortTable","collectionPath","pathSegments","replace","split","value","push","column","order","err"],"mappings":"AAGA,SAASA,GAAG,EAAEC,IAAI,QAAQ,cAAa;AAKvC,SAASC,uBAAuB,QAAQ,0CAAyC;AACjF,SAASC,sBAAsB,QAAQ,8BAA6B;AAcpE;;CAEC,GACD,OAAO,MAAMC,eAAe,CAAC,EAC3BC,OAAO,EACPC,UAAU,EACVC,MAAM,EACNC,KAAK,EACLC,MAAM,EACNC,iBAAiB,EACjBC,YAAY,EACZC,IAAI,EACJC,SAAS,EACJ;IACL,MAAMC,UAAuC,EAAE;IAE/C,IAAI,CAACF,MAAM;QACT,MAAMG,YAAYV,QAAQW,MAAM,CAACH,UAAU,EAAEE;QAC7C,IAAIA,WAAW;YACbH,OAAO;QACT,OAAO;YACLA,OAAO;QACT;IACF;IAEA,IAAI,OAAOA,SAAS,UAAU;QAC5BA,OAAO;YAACA;SAAK;IACf;IAEA,KAAK,MAAMK,YAAYL,KAAM;QAC3B,IAAIM;QACJ,IAAIC;QACJ,IAAIF,QAAQ,CAAC,EAAE,KAAK,KAAK;YACvBC,eAAeD,SAASG,SAAS,CAAC;YAClCD,gBAAgB;QAClB,OAAO;YACLD,eAAeD;YACfE,gBAAgB;QAClB;QACA,IAAI;YACF,MAAM,EAAEE,YAAYC,mBAAmB,EAAEC,OAAOC,SAAS,EAAE,GAAGrB,uBAAuB;gBACnFE;gBACAoB,gBAAgBP;gBAChBX;gBACAC;gBACAC;gBACAC;gBACAgB,cAAcR,aAAaS,OAAO,CAAC,OAAO,KAAKC,KAAK,CAAC;gBACrDjB;gBACAE;gBACAgB,OAAOX;YACT;YACA,IAAIM,WAAW,CAACF,oBAAoB,EAAE;gBACpCR,QAAQgB,IAAI,CAAC;oBACXC,QACEzB,cAAcO,cAAcX,wBAAwBsB,aAChDlB,UAAU,CAACgB,oBAAoB,GAC/BE,SAAS,CAACF,oBAAoB;oBACpCU,OAAOb,kBAAkB,QAAQnB,MAAMC;gBACzC;gBAEAU,YAAY,CAACW,oBAAoB,GAAGE,SAAS,CAACF,oBAAoB;YACpE;QACF,EAAE,OAAOW,KAAK;QACZ,WAAW;QACb;IACF;IAEA,OAAOnB;AACT,EAAC"}