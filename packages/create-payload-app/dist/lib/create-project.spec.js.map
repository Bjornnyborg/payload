{"version":3,"sources":["../../src/lib/create-project.spec.ts"],"sourcesContent":["import { jest } from '@jest/globals'\nimport fs from 'fs'\nimport fse from 'fs-extra'\nimport globby from 'globby'\nimport * as os from 'node:os'\nimport path from 'path'\n\nimport type { CliArgs, DbType, ProjectExample, ProjectTemplate } from '../types.js'\n\nimport { createProject } from './create-project.js'\nimport { dbReplacements } from './replacements.js'\nimport { getValidTemplates } from './templates.js'\n\ndescribe('createProject', () => {\n  let projectDir: string\n  beforeAll(() => {\n    // eslint-disable-next-line no-console\n    console.log = jest.fn()\n  })\n\n  beforeEach(() => {\n    const tempDirectory = fs.realpathSync(os.tmpdir())\n    projectDir = `${tempDirectory}/${Math.random().toString(36).substring(7)}`\n  })\n\n  afterEach(() => {\n    if (fse.existsSync(projectDir)) {\n      fse.rmSync(projectDir, { recursive: true })\n    }\n  })\n\n  describe('#createProject', () => {\n    const args = {\n      _: ['project-name'],\n      '--db': 'mongodb',\n      '--local-template': 'blank',\n      '--no-deps': true,\n    } as CliArgs\n    const packageManager = 'yarn'\n\n    it('creates plugin template', async () => {\n      const projectName = 'plugin'\n      const template: ProjectTemplate = {\n        name: 'plugin',\n        type: 'plugin',\n        description: 'Template for creating a Payload plugin',\n        url: 'https://github.com/payloadcms/payload/templates/plugin',\n      }\n\n      await createProject({\n        cliArgs: { ...args, '--local-template': 'plugin' } as CliArgs,\n        packageManager,\n        projectDir,\n        projectName,\n        template,\n      })\n\n      const packageJsonPath = path.resolve(projectDir, 'package.json')\n      const packageJson = fse.readJsonSync(packageJsonPath)\n\n      // Check package name and description\n      expect(packageJson.name).toStrictEqual(projectName)\n    })\n\n    it('creates example', async () => {\n      const projectName = 'custom-server-example'\n      const example: ProjectExample = {\n        name: 'custom-server',\n        url: 'https://github.com/payloadcms/payload/examples/custom-server#main',\n      }\n\n      await createProject({\n        cliArgs: {\n          ...args,\n          '--local-template': undefined,\n          '--local-example': 'custom-server',\n        } as CliArgs,\n        packageManager,\n        projectDir,\n        projectName,\n        example,\n      })\n\n      const packageJsonPath = path.resolve(projectDir, 'package.json')\n      const packageJson = fse.readJsonSync(packageJsonPath)\n\n      // Check package name and description\n      expect(packageJson.name).toStrictEqual(projectName)\n    })\n\n    describe('creates project from template', () => {\n      const templates = getValidTemplates()\n\n      it.each([\n        ['blank', 'mongodb'],\n        ['blank', 'postgres'],\n\n        // TODO: Re-enable these once 3.0 is stable and templates updated\n        // ['website', 'mongodb'],\n        // ['website', 'postgres'],\n        // ['ecommerce', 'mongodb'],\n        // ['ecommerce', 'postgres'],\n      ])('update config and deps: %s, %s', async (templateName, db) => {\n        const projectName = 'starter-project'\n\n        const template = templates.find((t) => t.name === templateName)\n\n        const cliArgs = {\n          ...args,\n          '--db': db,\n          '--local-template': templateName,\n        } as CliArgs\n\n        await createProject({\n          cliArgs,\n          dbDetails: {\n            type: db as DbType,\n            dbUri: `${db}://localhost:27017/create-project-test`,\n          },\n          packageManager,\n          projectDir,\n          projectName,\n          template: template as ProjectTemplate,\n        })\n\n        const dbReplacement = dbReplacements[db as DbType]\n\n        const packageJsonPath = path.resolve(projectDir, 'package.json')\n        const packageJson = fse.readJsonSync(packageJsonPath)\n\n        // Verify git was initialized\n        expect(fse.existsSync(path.resolve(projectDir, '.git'))).toBe(true)\n\n        // Should only have one db adapter\n        expect(\n          Object.keys(packageJson.dependencies).filter((n) => n.startsWith('@payloadcms/db-')),\n        ).toHaveLength(1)\n\n        const payloadConfigPath = (\n          await globby('**/payload.config.ts', {\n            absolute: true,\n            cwd: projectDir,\n          })\n        )?.[0]\n\n        const content = fse.readFileSync(payloadConfigPath, 'utf-8')\n\n        // Check payload.config.ts\n        expect(content).not.toContain('// database-adapter-import')\n        expect(content).toContain(dbReplacement.importReplacement)\n\n        expect(content).not.toContain('// database-adapter-config-start')\n        expect(content).not.toContain('// database-adapter-config-end')\n        expect(content).toContain(dbReplacement.configReplacement().join('\\n'))\n      })\n    })\n  })\n})\n"],"names":["jest","fs","fse","globby","os","path","createProject","dbReplacements","getValidTemplates","describe","projectDir","beforeAll","console","log","fn","beforeEach","tempDirectory","realpathSync","tmpdir","Math","random","toString","substring","afterEach","existsSync","rmSync","recursive","args","_","packageManager","it","projectName","template","name","type","description","url","cliArgs","packageJsonPath","resolve","packageJson","readJsonSync","expect","toStrictEqual","example","undefined","templates","each","templateName","db","find","t","dbDetails","dbUri","dbReplacement","toBe","Object","keys","dependencies","filter","n","startsWith","toHaveLength","payloadConfigPath","absolute","cwd","content","readFileSync","not","toContain","importReplacement","configReplacement","join"],"mappings":"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"}